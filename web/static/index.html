<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üéôÔ∏è Voice Assistant</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f6f6f6;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    h1 {
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .mic {
      font-size: 36px;
      color: #555;
    }

    .btns {
      margin-top: 20px;
      display: flex;
      gap: 20px;
    }

    button {
      padding: 14px 32px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.2s;
    }

    #startBtn {
      background-color: #4CAF50;
      color: white;
    }

    #stopBtn {
      background-color: #f44336;
      color: white;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    button.active {
      transform: scale(1.1);
      filter: brightness(1.2);
    }

    /* üéµ Hi·ªáu ·ª©ng s√≥ng √¢m thanh */
    .wave {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 4px;
      height: 40px;
      margin-top: 50px;
      visibility: hidden;
    }

    .bar {
      width: 6px;
      height: 10px;
      background: #4caf50;
      border-radius: 3px;
      animation: bounce 1s infinite ease-in-out;
    }

    .bar:nth-child(2) { animation-delay: 0.1s; }
    .bar:nth-child(3) { animation-delay: 0.2s; }
    .bar:nth-child(4) { animation-delay: 0.3s; }
    .bar:nth-child(5) { animation-delay: 0.4s; }

    @keyframes bounce {
      0%, 100% { height: 10px; background: #4caf50; }
      50% { height: 40px; background: #81c784; }
    }
  </style>
</head>
<body>
  <h1><span class="mic">üé§</span>Voice Assistant</h1>

  <div class="btns">
    <button id="startBtn">Start</button>
    <button id="stopBtn" disabled>Stop</button>
  </div>

  <div class="wave" id="wave">
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
  </div>

  <audio id="player"></audio>

  <script>
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const player = document.getElementById('player');
    const wave = document.getElementById('wave');
    let ws, mediaRecorder;

    startBtn.addEventListener('click', async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const clientId = Math.random().toString(36).slice(2, 10);
      ws = new WebSocket(`ws://${location.host}/ws/${clientId}`);
      ws.binaryType = "arraybuffer";

      ws.onopen = () => {
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => {
          if (e.data.size > 0 && ws.readyState === WebSocket.OPEN) {
            e.data.arrayBuffer().then(buf => ws.send(buf));
          }
        };
        mediaRecorder.start(500);
        startBtn.disabled = true;
        stopBtn.disabled = false;
        startBtn.classList.add('active');
        wave.style.visibility = 'visible';
      };

      ws.onmessage = ev => {
        try {
          const data = JSON.parse(ev.data);
          if (data.status === "done") {
            player.src = data.tts_url + "?t=" + Date.now();
            player.play();
          }
        } catch {}
      };

      ws.onclose = () => {
        startBtn.disabled = false;
        stopBtn.disabled = true;
        startBtn.classList.remove('active');
        wave.style.visibility = 'hidden';
      };
    });

    stopBtn.addEventListener('click', () => {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
      }
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: "finish" }));
      }
      stopBtn.classList.add('active');
      setTimeout(() => stopBtn.classList.remove('active'), 300);
    });

    player.addEventListener('ended', () => {
      wave.style.visibility = 'hidden';
      startBtn.disabled = false;
      stopBtn.disabled = true;
      startBtn.classList.remove('active');
    });
  </script>
</body>
</html>
