<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ™ï¸ FastAPI Voice Chat</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; background: #fafafa; }
    h1 { color: #444; }
    button { padding: 10px 20px; font-size: 16px; margin-right: 10px; cursor: pointer; border-radius: 6px; border: 1px solid #ccc; }
    button:disabled { background: #ddd; cursor: not-allowed; }
    #log { margin-top: 20px; white-space: pre-wrap; background: #f4f4f4; padding: 10px; border-radius: 6px; height: 200px; overflow-y: auto; }
    audio { display: none; } /* ğŸ”¥ áº¨n thanh phÃ¡t audio */
  </style>
</head>
<body>
  <h1>ğŸ§ Voice Assistant (FastAPI + WebSocket)</h1>
  <p>Báº¥m <b>Start</b> Ä‘á»ƒ ghi Ã¢m, <b>Stop</b> Ä‘á»ƒ dá»«ng vÃ  nghe pháº£n há»“i.</p>

  <button id="startBtn">Start</button>
  <button id="stopBtn" disabled>Stop</button>
  <audio id="player"></audio> <!-- KhÃ´ng hiá»‡n ra -->

  <div id="log"></div>

  <script>
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const player = document.getElementById('player');
    const logEl = document.getElementById('log');

    let ws, mediaRecorder;

    function log(msg) {
      logEl.textContent += msg + '\n';
      logEl.scrollTop = logEl.scrollHeight;
    }

    startBtn.addEventListener('click', async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const clientId = Math.random().toString(36).slice(2, 10);
      ws = new WebSocket(`ws://${location.host}/ws/${clientId}`);
      ws.binaryType = "arraybuffer";

      ws.onopen = () => {
        log("âœ… WebSocket connected");
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = (e) => {
          if (e.data.size > 0 && ws.readyState === WebSocket.OPEN) {
            e.data.arrayBuffer().then(buf => ws.send(buf));
          }
        };
        mediaRecorder.start(500);
        startBtn.disabled = true;
        stopBtn.disabled = false;
        log("ğŸ™ï¸ Recording...");
      };

      ws.onmessage = (ev) => {
        try {
          const data = JSON.parse(ev.data);
          if (data.status === "done") {
            log("ğŸ§  Bot reply: " + data.text);
            player.src = data.tts_url + "?t=" + Date.now();
            player.play().then(() => {
              log("ğŸµ Playing audio (hidden)...");
            });
          }
        } catch {
          console.warn("Non-JSON message:", ev.data);
        }
      };

      ws.onclose = () => {
        log("âŒ WebSocket closed");
        startBtn.disabled = false;
        stopBtn.disabled = true;
      };
    });

    stopBtn.addEventListener('click', () => {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
        log("ğŸ›‘ Recording stopped");
      }
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: "finish" }));
        log("ğŸ“¤ Sent finish signal, waiting for bot reply...");
      }
      stopBtn.disabled = true;
    });

    // âœ… Khi audio phÃ¡t xong â†’ má»Ÿ láº¡i Start
    player.addEventListener('ended', () => {
      log("âœ… Audio playback finished. Ready for next input.");
      startBtn.disabled = false;
      stopBtn.disabled = true;
    });
  </script>
</body>
</html>
